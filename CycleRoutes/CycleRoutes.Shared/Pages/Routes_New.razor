@page "/routes"
@inject IRouteService RouteService
@inject IStreetViewService StreetViewService
@inject IGoogleMapsService GoogleMapsService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Cycle Routes</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="@(isRouteManagementCollapsed ? "col-md-1" : "col-md-4") route-management-panel @(isRouteManagementCollapsed ? "collapsed" : "")">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 @(isRouteManagementCollapsed ? "d-none" : "")">Route Management</h5>
                    <button class="btn btn-sm btn-outline-secondary route-management-toggle" @onclick="ToggleRouteManagement" title="@(isRouteManagementCollapsed ? "Expand Panel" : "Collapse Panel")">
                        @if (isRouteManagementCollapsed)
                        {
                            <i class="bi bi-chevron-right" style="transform: scale(1.2);"></i>
                        }
                        else
                        {
                            <i class="bi bi-chevron-left" style="transform: scale(1.2);"></i>
                        }
                    </button>
                </div>
                @if (!isRouteManagementCollapsed)
                {
                    <div class="card-body">
                        <!-- File Upload -->
                        <div class="mb-3">
                            <label for="gpxFile" class="form-label">Upload GPX File</label>
                            <InputFile OnChange="OnFileSelected" accept=".gpx" class="form-control" id="gpxFile" />
                        </div>

                        @if (isLoading)
                        {
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading route...</p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <div class="alert @(statusMessage.Contains("Error") ? "alert-danger" : "alert-success")" role="alert">
                                @statusMessage
                            </div>
                        }

                        <!-- Saved Routes -->
                        <div class="mb-3">
                            <h6>Saved Routes</h6>
                            @if (savedRoutes.Any())
                            {
                                <div class="list-group">
                                    @foreach (var route in savedRoutes)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@route.Name</strong><br>
                                                <small class="text-muted">
                                                    @{
                                                        var actualDistance = route.CalculateTotalDistance();
                                                    }
                                                    @((actualDistance / 1000).ToString("F1")) km ‚Ä¢ @route.Points.Count points
                                                </small>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-primary me-1" @onclick="() => LoadRoute(route)">
                                                    Load
                                                </button>
                                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteRoute(route.Name)">
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">No saved routes</p>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="card-body d-flex flex-column align-items-center justify-content-center text-center py-4" style="min-height: 200px;">
                        <div class="text-muted mb-3" style="writing-mode: vertical-lr; transform: rotate(180deg); letter-spacing: 3px; font-weight: 500; font-size: 0.9rem;">
                            ROUTES
                        </div>
                        <div class="text-muted" style="font-size: 0.8rem; writing-mode: vertical-lr; transform: rotate(180deg);">
                            üìÅ
                        </div>
                    </div>
                }
            </div>

            <!-- Current Route Info -->
            @if (currentRoute != null && !isRouteManagementCollapsed)
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Current Route: @currentRoute.Name</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Distance:</strong> @((currentRoute.CalculateTotalDistance() / 1000).ToString("F1")) km</p>
                        <p><strong>Points:</strong> @currentRoute.Points.Count</p>
                        @if (!isNavigating)
                        {
                            <button class="btn btn-success" @onclick="StartRoute">
                                <i class="bi bi-play-fill"></i> Start Navigation
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger me-2" @onclick="StopRoute">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">Point @(currentPointIndex + 1) of @currentRoute.Points.Count</small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="@(isRouteManagementCollapsed ? "col-md-11" : "col-md-8")">
            @if (currentRoute != null && currentRoute.Points.Any())
            {
                var currentPoint = isNavigating ? currentRoute.Points[currentPointIndex] : currentRoute.StartPoint!;
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Street View</h6>
                        @if (isNavigating)
                        {
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" @onclick="PreviousPoint" disabled="@(currentPointIndex == 0)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                
                                @if (isAutoAdvancing)
                                {
                                    @if (isAutoAdvancePaused)
                                    {
                                        <button class="btn btn-sm btn-warning" @onclick="ResumeAutoAdvance">
                                            <i class="bi bi-play"></i> Resume
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-warning" @onclick="PauseAutoAdvance">
                                            <i class="bi bi-pause"></i> Pause
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-secondary" @onclick="StopAutoAdvance">
                                        <i class="bi bi-stop"></i> Stop Auto
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-success" @onclick="StartAutoAdvance">
                                        <i class="bi bi-fast-forward"></i> Auto
                                    </button>
                                }
                                
                                <button class="btn btn-sm btn-outline-primary" @onclick="NextPoint" disabled="@(currentPointIndex >= currentRoute.Points.Count - 1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        }
                    </div>
                    <div class="card-body p-0">
                        @if (StreetViewService.HasApiKey)
                        {
                            <iframe src="@StreetViewService.GetStreetViewUrl(currentPoint.Latitude, currentPoint.Longitude, 0)" 
                                    width="100%" height="400" style="border: none;"></iframe>
                        }
                        else
                        {
                            <div class="alert alert-warning m-3" role="alert">
                                <h6>Google Street View API Key Required</h6>
                                <p class="mb-2">@apiKeyStatusMessage</p>
                                @if (isValidatingApiKey)
                                {
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>Validating API key...</span>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="ValidateApiKey">
                                        Validate API Key
                                    </button>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Progress Bar -->
                @if (isNavigating)
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Progress: @(currentPointIndex + 1) / @currentRoute.Points.Count</span>
                                <span class="text-muted">@(((double)(currentPointIndex + 1) / currentRoute.Points.Count * 100).ToString("F1"))%</span>
                            </div>
                            <div class="progress clickable-progress" id="clickable-progress" style="height: 25px; cursor: pointer;" @onclick="OnProgressBarClick">
                                <div class="progress-bar" 
                                     role="progressbar" 
                                     style="width: @(((double)(currentPointIndex + 1) / currentRoute.Points.Count * 100).ToString("F1"))%"
                                     aria-valuenow="@(currentPointIndex + 1)" 
                                     aria-valuemin="0" 
                                     aria-valuemax="@currentRoute.Points.Count">
                                    Point @(currentPointIndex + 1)
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Google Maps Route Overview -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Route Overview</h6>
                        <div>
                            <small class="text-muted">Click on the route to jump to that point</small>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        @if (GoogleMapsService.HasApiKey)
                        {
                            @if (isMapLoading)
                            {
                                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading map...</span>
                                        </div>
                                        <p class="mt-2">Loading map...</p>
                                    </div>
                                </div>
                            }
                            <div id="routeMap" style="height: 400px; width: 100%;" class="@(isMapLoading ? "d-none" : "")"></div>
                        }
                        else
                        {
                            <div class="alert alert-warning m-3" role="alert">
                                <h6>Google Maps API Key Required</h6>
                                <p class="mb-0">@apiKeyStatusMessage</p>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="text-muted">No Route Loaded</h5>
                        <p class="text-muted">Upload a GPX file to get started with route navigation.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<CycleRoute> savedRoutes = new();
    private CycleRoute? currentRoute;
    private bool isLoading;
    private string statusMessage = string.Empty;
    private bool isNavigating;
    private int currentPointIndex;
    private Timer? navigationTimer;
    private bool isValidatingApiKey;
    private string apiKeyStatusMessage = string.Empty;
    private bool showApiKeyError;
    private bool isRouteManagementCollapsed = false;

    // Google Maps functionality
    private bool isMapLoading = true;
    private bool isMapInitialized = false;

    // Auto-advance functionality
    private bool isAutoAdvancing;
    private bool isAutoAdvancePaused;
    private int autoAdvanceIntervalSeconds = 3;
    private string autoAdvanceDirection = "forward";
    private Timer? autoAdvanceTimer;

    protected override async Task OnInitializedAsync()
    {
        RouteService.CurrentRouteChanged += OnCurrentRouteChanged;
        savedRoutes = await RouteService.GetSavedRoutesAsync();
        currentRoute = RouteService.CurrentRoute;
        
        // For WebAssembly, call ValidateApiKeyAsync which will ensure configuration is loaded
        await GoogleMapsService.ValidateApiKeyAsync();
        
        await UpdateApiKeyStatus();
        
        // Initialize map if we already have a route loaded
        if (currentRoute != null)
        {
            await InitializeMap();
        }
    }

    private async Task UpdateApiKeyStatus()
    {
        apiKeyStatusMessage = StreetViewService.GetApiKeyStatus();
        if (StreetViewService.HasApiKey)
        {
            isValidatingApiKey = true;
            StateHasChanged();
            
            var isValid = await StreetViewService.ValidateApiKeyAsync();
            apiKeyStatusMessage = StreetViewService.GetApiKeyStatus();
            
            isValidatingApiKey = false;
            StateHasChanged();
        }
    }

    private async Task ValidateApiKey()
    {
        await UpdateApiKeyStatus();
    }

    private async Task InitializeMap()
    {
        if (currentRoute == null)
        {
            Console.WriteLine("Cannot initialize map - missing route");
            return;
        }

        try
        {
            Console.WriteLine("Starting map initialization...");
            isMapLoading = true;
            StateHasChanged();

            // For WebAssembly, ensure we load configuration first
            if (!GoogleMapsService.HasApiKey)
            {
                Console.WriteLine("No API key available, attempting to load configuration...");
                await GoogleMapsService.ValidateApiKeyAsync();
            }

            // Check if we have API key after potential loading
            if (!GoogleMapsService.HasApiKey)
            {
                Console.WriteLine("Cannot initialize map - missing API key after configuration attempt");
                isMapLoading = false;
                StateHasChanged();
                return;
            }

            // Ensure the map container exists
            var mapExists = await JSRuntime.InvokeAsync<bool>("eval", "document.getElementById('routeMap') !== null");
            if (!mapExists)
            {
                Console.WriteLine("Map container not found, waiting...");
                await Task.Delay(1000);
                mapExists = await JSRuntime.InvokeAsync<bool>("eval", "document.getElementById('routeMap') !== null");
                if (!mapExists)
                {
                    Console.WriteLine("Map container still not found after delay");
                    isMapLoading = false;
                    StateHasChanged();
                    return;
                }
            }

            Console.WriteLine("Map container found, proceeding with initialization...");

            // Generate scripts
            var mapScript = GoogleMapsService.GenerateMapInitializationScript(currentRoute, "routeMap", currentPointIndex);
            var clickScript = GoogleMapsService.GenerateRouteClickScript(currentRoute, "onRouteMapClick");
            
            // Set up the callback function for route clicks
            await JSRuntime.InvokeVoidAsync("eval", @"
                window.onRouteMapClick = function(pointIndex) {
                    DotNet.invokeMethodAsync('CycleRoutes.Shared', 'OnMapRouteClick', pointIndex);
                };
            ");
            
            // Define the callback function that the Google Maps API will call
            var initScript = $@"
                window.initGoogleMaps = function() {{
                    console.log('Google Maps API callback triggered');
                    window.googleMapsApiLoaded = true;
                    try {{
                        {mapScript}
                        console.log('Route map initialized successfully');
                        
                        // Add click listeners to the route
                        {clickScript}
                        
                    }} catch (error) {{
                        console.error('Error initializing route map:', error);
                    }}
                }};
            ";
            
            await JSRuntime.InvokeVoidAsync("eval", initScript);

            // Load the Google Maps API if not already loaded
            if (!isMapInitialized)
            {
                Console.WriteLine("Loading Google Maps API...");
                var loadScript = $@"
                    console.log('Checking if Google Maps API is loaded...');
                    if (!window.googleMapsApiLoaded) {{
                        console.log('Loading Google Maps API script...');
                        const script = document.createElement('script');
                        script.src = '{GoogleMapsService.GetMapsApiUrl()}';
                        script.async = true;
                        script.defer = true;
                        script.onerror = function() {{
                            console.error('Failed to load Google Maps API');
                        }};
                        document.head.appendChild(script);
                    }} else {{
                        console.log('Google Maps API already loaded, initializing map...');
                        if (window.initGoogleMaps) {{
                            window.initGoogleMaps();
                        }}
                    }}
                ";

                await JSRuntime.InvokeVoidAsync("eval", loadScript);
            }
            
            // If API is already loaded, call the callback immediately
            await JSRuntime.InvokeVoidAsync("eval", @"
                if (window.googleMapsApiLoaded && typeof google !== 'undefined') {
                    console.log('Google Maps API already ready, calling callback immediately...');
                    window.initGoogleMaps();
                } else {
                    console.log('Waiting for Google Maps API to load...');
                }
            ");

            isMapInitialized = true;
            
            // Give it a moment to initialize
            await Task.Delay(2000);
            
            isMapLoading = false;
            StateHasChanged();
            Console.WriteLine("Map initialization completed");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
            isMapLoading = false;
            StateHasChanged();
        }
    }

    private async Task UpdateMapPosition()
    {
        if (currentRoute == null || !GoogleMapsService.HasApiKey || !isMapInitialized)
            return;

        try
        {
            var currentPoint = currentRoute.Points[currentPointIndex];
            var updateScript = GoogleMapsService.GenerateUpdatePositionScript(currentPoint, "routeMap");
            await JSRuntime.InvokeVoidAsync("eval", updateScript);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating map position: {ex.Message}");
        }
    }

    private void ToggleRouteManagement()
    {
        isRouteManagementCollapsed = !isRouteManagementCollapsed;
    }

    private void OnCurrentRouteChanged(CycleRoute? route)
    {
        currentRoute = route;
        isNavigating = false;
        currentPointIndex = 0;
        showApiKeyError = false;
        isMapLoading = true;
        isMapInitialized = false;
        StopAutoAdvance();
        
        InvokeAsync(async () =>
        {
            StateHasChanged();
            if (currentRoute != null && GoogleMapsService.HasApiKey)
            {
                // Add a small delay to ensure the DOM is ready
                await Task.Delay(500);
                await InitializeMap();
            }
        });
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        isLoading = true;
        statusMessage = string.Empty;
        StateHasChanged();

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB limit
            var route = await RouteService.LoadRouteFromGpxAsync(stream, file.Name);

            if (route != null)
            {
                await RouteService.SaveRouteAsync(route);
                RouteService.SetCurrentRoute(route);
                savedRoutes = await RouteService.GetSavedRoutesAsync();
                statusMessage = $"Successfully loaded route '{route.Name}' with {route.Points.Count} points.";
            }
            else
            {
                statusMessage = "Error: Could not load route from the selected file.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error loading file: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void LoadRoute(CycleRoute route)
    {
        RouteService.SetCurrentRoute(route);
        statusMessage = $"Loaded route '{route.Name}'";
    }

    private async Task DeleteRoute(string routeName)
    {
        await RouteService.DeleteRouteAsync(routeName);
        savedRoutes = await RouteService.GetSavedRoutesAsync();
        statusMessage = $"Deleted route '{routeName}'";
        StateHasChanged();
    }

    private void StartRoute()
    {
        if (currentRoute == null || !currentRoute.Points.Any()) return;

        isNavigating = true;
        currentPointIndex = 0;
        
        // Automatically start auto-advance for better user experience
        StartAutoAdvance();
        
        StateHasChanged();
    }

    private void StopRoute()
    {
        isNavigating = false;
        StopAutoAdvance();
        navigationTimer?.Dispose();
        StateHasChanged();
    }

    private void StartAutoAdvance()
    {
        if (currentRoute == null || !currentRoute.Points.Any()) return;

        isAutoAdvancing = true;
        isAutoAdvancePaused = false;
        CreateAutoAdvanceTimer();
        StateHasChanged();
    }

    private void PauseAutoAdvance()
    {
        isAutoAdvancePaused = true;
        autoAdvanceTimer?.Dispose();
        StateHasChanged();
    }

    private void ResumeAutoAdvance()
    {
        isAutoAdvancePaused = false;
        CreateAutoAdvanceTimer();
        StateHasChanged();
    }

    private void StopAutoAdvance()
    {
        isAutoAdvancing = false;
        isAutoAdvancePaused = false;
        autoAdvanceTimer?.Dispose();
        StateHasChanged();
    }

    private void CreateAutoAdvanceTimer()
    {
        autoAdvanceTimer?.Dispose();
        autoAdvanceTimer = new Timer(AutoAdvanceCallback, null, 
            TimeSpan.FromSeconds(autoAdvanceIntervalSeconds), 
            TimeSpan.FromSeconds(autoAdvanceIntervalSeconds));
    }

    private void AutoAdvanceCallback(object? state)
    {
        if (!isAutoAdvancing || isAutoAdvancePaused || currentRoute == null)
            return;

        InvokeAsync(() =>
        {
            if (autoAdvanceDirection == "forward")
            {
                if (currentPointIndex < currentRoute.Points.Count - 1)
                {
                    NextPoint();
                }
                else
                {
                    // Reached the end, stop auto-advance
                    StopAutoAdvance();
                }
            }
            else // reverse
            {
                if (currentPointIndex > 0)
                {
                    PreviousPoint();
                }
                else
                {
                    // Reached the beginning, stop auto-advance
                    StopAutoAdvance();
                }
            }
        });
    }

    private async void NextPoint()
    {
        if (currentRoute != null && currentPointIndex < currentRoute.Points.Count - 1)
        {
            currentPointIndex++;
            StateHasChanged();
            await UpdateMapPosition();
        }
    }

    private async void PreviousPoint()
    {
        if (currentPointIndex > 0)
        {
            currentPointIndex--;
            StateHasChanged();
            await UpdateMapPosition();
        }
    }

    private async Task OnProgressBarClick(MouseEventArgs e)
    {
        if (currentRoute == null || !isNavigating) return;

        try
        {
            // Calculate the clicked percentage based on the click position
            var clickPercentage = await JSRuntime.InvokeAsync<double>("calculateClickPercentage", e, "clickable-progress");
            
            if (clickPercentage >= 0 && clickPercentage <= 1)
            {
                // Calculate the target point index based on the clicked percentage
                var targetIndex = (int)Math.Round(clickPercentage * (currentRoute.Points.Count - 1));
                
                // Ensure the index is within bounds
                targetIndex = Math.Max(0, Math.Min(targetIndex, currentRoute.Points.Count - 1));
                
                // Jump to the selected point
                if (targetIndex != currentPointIndex)
                {
                    currentPointIndex = targetIndex;
                    StateHasChanged();
                    await UpdateMapPosition();
                }
            }
        }
        catch (Exception ex)
        {
            // Handle any JavaScript errors gracefully
            Console.WriteLine($"Error handling progress bar click: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMapRouteClick(int pointIndex)
    {
        if (currentRoute == null || !isNavigating) 
            return;

        // Ensure the point index is within bounds
        pointIndex = Math.Max(0, Math.Min(pointIndex, currentRoute.Points.Count - 1));
        
        // Jump to the selected point
        if (pointIndex != currentPointIndex)
        {
            currentPointIndex = pointIndex;
            StateHasChanged();
            await UpdateMapPosition();
        }
    }

    public void Dispose()
    {
        RouteService.CurrentRouteChanged -= OnCurrentRouteChanged;
        navigationTimer?.Dispose();
        autoAdvanceTimer?.Dispose();
    }
}
